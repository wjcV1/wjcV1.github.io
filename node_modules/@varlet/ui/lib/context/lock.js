"use strict";

exports.__esModule = true;
exports.addLock = addLock;
exports.releaseLock = releaseLock;
exports.resolveLock = resolveLock;
exports.useLock = useLock;

var _vue = require("vue");

var _ = _interopRequireDefault(require("."));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function resolveLock() {
  var lockCounts = Object.keys(_.default.locks).length;
  lockCounts <= 0 ? document.body.classList.remove('var--lock') : document.body.classList.add('var--lock');
}

function addLock(uid) {
  _.default.locks[uid] = 1;
  resolveLock();
}

function releaseLock(uid) {
  delete _.default.locks[uid];
  resolveLock();
}

function useLock(source, useSource) {
  var {
    uid
  } = (0, _vue.getCurrentInstance)();

  if (useSource) {
    (0, _vue.watch)(useSource, newValue => {
      if (newValue === false) {
        // 改变为禁用状态 组件解锁
        releaseLock(uid);
      } else if (newValue === true && source() === true) {
        // 改变为启用状态 并且popup处于开启状态 组件加锁
        addLock(uid);
      }
    });
  }

  (0, _vue.watch)(source, newValue => {
    if (useSource && useSource() === false) {
      return;
    }

    if (newValue === true) {
      // popup开启 组件加锁
      addLock(uid);
    } else {
      // popup关闭 组件解锁
      releaseLock(uid);
    }
  });
  (0, _vue.onBeforeMount)(() => {
    if (useSource && useSource() === false) {
      return;
    }

    if (source() === true) {
      // popup处于开启状态 组件挂载 组件加锁
      addLock(uid);
    }
  });
  (0, _vue.onUnmounted)(() => {
    if (useSource && useSource() === false) {
      return;
    }

    if (source() === true) {
      // popup处于开启状态 组件卸载 组件解锁
      releaseLock(uid);
    }
  });
  (0, _vue.onActivated)(() => {
    if (useSource && useSource() === false) {
      return;
    }

    if (source() === true) {
      // popup处于开启状态 组件处于keepalive前台 组件加锁
      addLock(uid);
    }
  });
  (0, _vue.onDeactivated)(() => {
    if (useSource && useSource() === false) {
      return;
    }

    if (source() === true) {
      // popup处于开启状态 组件处于keepalive后台 组件解锁
      releaseLock(uid);
    }
  });
}