function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

import { computed, defineComponent, ref, watch, onMounted, onBeforeUnmount } from 'vue';
import { isPlainObject, toNumber } from '@varlet/shared';
import { easeInOutCubic } from '../utils/shared';
import { doubleRaf, getParentScroller, getScrollLeft, getScrollTop, nextTickFrame, requestAnimationFrame, scrollTo as varScrollTo, toPxNum } from '../utils/elements';
import { useIndexAnchors } from './provide';
import { props } from './props';
import { createNamespace, call } from '../utils/components';
var {
  n,
  classes
} = createNamespace('index-bar');
import { renderSlot as _renderSlot, renderList as _renderList, Fragment as _Fragment, openBlock as _openBlock, createElementBlock as _createElementBlock, toDisplayString as _toDisplayString, normalizeClass as _normalizeClass, normalizeStyle as _normalizeStyle, createElementVNode as _createElementVNode, pushScopeId as _pushScopeId, popScopeId as _popScopeId } from "vue";

var _withScopeId = n => (_pushScopeId(""), n = n(), _popScopeId(), n);

var _hoisted_1 = ["onClick"];
export function render(_ctx, _cache) {
  return _openBlock(), _createElementBlock("div", {
    class: _normalizeClass(_ctx.n()),
    ref: "barEl"
  }, [_renderSlot(_ctx.$slots, "default"), _createElementVNode("ul", {
    class: _normalizeClass(_ctx.n('anchor-list')),
    style: _normalizeStyle({
      zIndex: _ctx.toNumber(_ctx.zIndex) + 2,
      display: _ctx.hideList ? 'none' : 'block'
    })
  }, [(_openBlock(true), _createElementBlock(_Fragment, null, _renderList(_ctx.anchorNameList, anchorName => {
    return _openBlock(), _createElementBlock("li", {
      key: anchorName,
      class: _normalizeClass(_ctx.classes(_ctx.n('anchor-item'), [_ctx.active === anchorName, _ctx.n('anchor-item--active')])),
      style: _normalizeStyle({
        color: _ctx.active === anchorName && _ctx.highlightColor ? _ctx.highlightColor : ''
      }),
      onClick: $event => _ctx.anchorClick(anchorName, true)
    }, _toDisplayString(anchorName), 15
    /* TEXT, CLASS, STYLE, PROPS */
    , _hoisted_1);
  }), 128
  /* KEYED_FRAGMENT */
  ))], 6
  /* CLASS, STYLE */
  )], 2
  /* CLASS */
  );
}
export default defineComponent({
  render,
  name: 'VarIndexBar',
  props,

  setup(props) {
    var {
      length,
      indexAnchors,
      bindIndexAnchors
    } = useIndexAnchors();
    var clickedName = ref('');
    var scroller = ref(null);
    var barEl = ref(null);
    var anchorNameList = ref([]);
    var active = ref();
    var sticky = computed(() => props.sticky);
    var cssMode = computed(() => props.cssMode);
    var stickyOffsetTop = computed(() => toPxNum(props.stickyOffsetTop));
    var zIndex = computed(() => props.zIndex);
    var indexBarProvider = {
      active,
      sticky,
      cssMode,
      stickyOffsetTop,
      zIndex
    };
    bindIndexAnchors(indexBarProvider);

    var emitEvent = anchor => {
      var anchorName = isPlainObject(anchor) ? anchor.name.value : anchor;
      if (anchorName === active.value || anchorName === undefined) return;
      active.value = anchorName;
      call(props.onChange, anchorName);
    };

    var handleScroll = () => {
      var scrollTop = getScrollTop(scroller.value);
      var scrollHeight = scroller.value === window ? document.body.scrollHeight : scroller.value.scrollHeight;
      var {
        offsetTop
      } = barEl.value;
      indexAnchors.forEach((anchor, index) => {
        var anchorTop = anchor.ownTop.value;
        var top = scrollTop - anchorTop + stickyOffsetTop.value - offsetTop;
        var distance = index === indexAnchors.length - 1 ? scrollHeight : indexAnchors[index + 1].ownTop.value - anchor.ownTop.value;

        if (top >= 0 && top < distance && !clickedName.value) {
          if (index && !props.cssMode) {
            indexAnchors[index - 1].setDisabled(true);
          }

          anchor.setDisabled(false);
          emitEvent(anchor);
        }
      });
    };

    var anchorClick = /*#__PURE__*/function () {
      var _ref = _asyncToGenerator(function* (anchorName, manualCall) {
        var {
          offsetTop
        } = barEl.value;
        if (manualCall) call(props.onClick, anchorName);
        if (anchorName === active.value) return;
        var indexAnchor = indexAnchors.find(_ref2 => {
          var {
            name
          } = _ref2;
          return anchorName === name.value;
        });
        if (!indexAnchor) return;
        var top = indexAnchor.ownTop.value - stickyOffsetTop.value + offsetTop;
        var left = getScrollLeft(scroller.value);
        clickedName.value = anchorName;
        emitEvent(anchorName);
        yield varScrollTo(scroller.value, {
          left,
          top,
          animation: easeInOutCubic,
          duration: toNumber(props.duration)
        });
        nextTickFrame(() => {
          clickedName.value = '';
        });
      });

      return function anchorClick(_x, _x2) {
        return _ref.apply(this, arguments);
      };
    }(); // expose


    var scrollTo = index => {
      requestAnimationFrame(() => anchorClick(index));
    };

    watch(() => length.value, /*#__PURE__*/_asyncToGenerator(function* () {
      yield doubleRaf();
      indexAnchors.forEach(_ref4 => {
        var {
          name,
          setOwnTop
        } = _ref4;
        if (name.value) anchorNameList.value.push(name.value);
        setOwnTop();
      });
    }));
    onMounted( /*#__PURE__*/_asyncToGenerator(function* () {
      yield doubleRaf();
      scroller.value = getParentScroller(barEl.value);
      scroller.value.addEventListener('scroll', handleScroll);
    }));
    onBeforeUnmount(() => {
      call(scroller.value.removeEventListener, 'scroll', handleScroll);
    });
    return {
      n,
      classes,
      barEl,
      active,
      zIndex,
      anchorNameList,
      toNumber,
      scrollTo,
      anchorClick
    };
  }

});