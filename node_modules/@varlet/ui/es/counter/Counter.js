import VarIcon from '../icon';
import VarFormDetails from '../form-details';
import Ripple from '../ripple';
import { defineComponent, ref, watch, computed, nextTick } from 'vue';
import { Decimal } from 'decimal.js';
import { props } from './props';
import { toNumber } from '@varlet/shared';
import { toSizeUnit } from '../utils/elements';
import { useForm } from '../form/provide';
import { useValidation, createNamespace, call } from '../utils/components';
var {
  n,
  classes
} = createNamespace('counter');
var SPEED = 100;
var DELAY = 600;
import { resolveComponent as _resolveComponent, normalizeClass as _normalizeClass, normalizeStyle as _normalizeStyle, resolveDirective as _resolveDirective, createVNode as _createVNode, withDirectives as _withDirectives, vModelText as _vModelText, createElementVNode as _createElementVNode, mergeProps as _mergeProps, openBlock as _openBlock, createElementBlock as _createElementBlock, pushScopeId as _pushScopeId, popScopeId as _popScopeId } from "vue";

var _withScopeId = n => (_pushScopeId(""), n = n(), _popScopeId(), n);

var _hoisted_1 = ["inputmode", "readonly", "disabled"];
export function render(_ctx, _cache) {
  var _component_var_icon = _resolveComponent("var-icon");

  var _component_var_form_details = _resolveComponent("var-form-details");

  var _directive_ripple = _resolveDirective("ripple");

  return _openBlock(), _createElementBlock("div", {
    class: _normalizeClass(_ctx.classes(_ctx.n(), 'var--box'))
  }, [_createElementVNode("div", _mergeProps({
    class: _ctx.classes(_ctx.n('controller'), 'var-elevation--2', [_ctx.disabled || _ctx.formDisabled, _ctx.n('--disabled')], [_ctx.errorMessage, _ctx.n('--error')]),
    style: {
      background: _ctx.color ? _ctx.color : undefined
    }
  }, _ctx.$attrs), [_withDirectives(_createVNode(_component_var_icon, {
    "var-counter-cover": "",
    name: "minus",
    class: _normalizeClass(_ctx.classes(_ctx.n('decrement-button'), [!_ctx.decrementButton, _ctx.n('--hidden')])),
    style: _normalizeStyle({
      width: _ctx.toSizeUnit(_ctx.buttonSize),
      height: _ctx.toSizeUnit(_ctx.buttonSize)
    }),
    onClick: _ctx.decrement,
    onTouchstart: _ctx.pressDecrement,
    onTouchend: _ctx.releaseDecrement,
    onTouchcancel: _ctx.releaseDecrement
  }, null, 8
  /* PROPS */
  , ["class", "style", "onClick", "onTouchstart", "onTouchend", "onTouchcancel"]), [[_directive_ripple, {
    disabled: !_ctx.ripple || _ctx.disabled || _ctx.readonly || _ctx.disableDecrement || !_ctx.decrementButton || _ctx.isMin
  }]]), _withDirectives(_createElementVNode("input", {
    class: _normalizeClass(_ctx.n('input')),
    style: _normalizeStyle({
      width: _ctx.toSizeUnit(_ctx.inputWidth),
      fontSize: _ctx.toSizeUnit(_ctx.inputTextSize)
    }),
    inputmode: _ctx.toNumber(_ctx.decimalLength) === 0 ? 'numeric' : 'decimal',
    readonly: _ctx.readonly || _ctx.formReadonly,
    disabled: _ctx.disabled || _ctx.formDisabled || _ctx.disableInput,
    "onUpdate:modelValue": _cache[0] || (_cache[0] = $event => _ctx.inputValue = $event),
    onChange: _cache[1] || (_cache[1] = function () {
      return _ctx.handleChange && _ctx.handleChange(...arguments);
    })
  }, null, 46
  /* CLASS, STYLE, PROPS, HYDRATE_EVENTS */
  , _hoisted_1), [[_vModelText, _ctx.inputValue]]), _withDirectives(_createVNode(_component_var_icon, {
    "var-counter-cover": "",
    name: "plus",
    class: _normalizeClass(_ctx.classes(_ctx.n('increment-button'), [!_ctx.incrementButton, _ctx.n('--hidden')])),
    style: _normalizeStyle({
      width: _ctx.toSizeUnit(_ctx.buttonSize),
      height: _ctx.toSizeUnit(_ctx.buttonSize)
    }),
    onClick: _ctx.increment,
    onTouchstart: _ctx.pressIncrement,
    onTouchend: _ctx.releaseIncrement,
    onTouchcancel: _ctx.releaseIncrement
  }, null, 8
  /* PROPS */
  , ["class", "style", "onClick", "onTouchstart", "onTouchend", "onTouchcancel"]), [[_directive_ripple, {
    disabled: !_ctx.ripple || _ctx.disabled || _ctx.readonly || _ctx.disableIncrement || !_ctx.incrementButton || _ctx.isMax
  }]])], 16
  /* FULL_PROPS */
  ), _createVNode(_component_var_form_details, {
    "error-message": _ctx.errorMessage
  }, null, 8
  /* PROPS */
  , ["error-message"])], 2
  /* CLASS */
  );
}
export default defineComponent({
  render,
  name: 'VarCounter',
  components: {
    VarIcon,
    VarFormDetails
  },
  directives: {
    Ripple
  },
  inheritAttrs: false,
  props,

  setup(props) {
    var inputValue = ref('');
    var incrementTimer;
    var decrementTimer;
    var incrementDelayTimer;
    var decrementDelayTimer;
    var {
      bindForm,
      form
    } = useForm();
    var {
      errorMessage,
      validateWithTrigger: vt,
      validate: v,
      // expose
      resetValidation
    } = useValidation();
    var {
      readonly: formReadonly,
      disabled: formDisabled
    } = form != null ? form : {}; // expose

    var validate = () => v(props.rules, props.modelValue);

    var validateWithTrigger = trigger => {
      nextTick(() => {
        var {
          validateTrigger,
          rules,
          modelValue
        } = props;
        vt(validateTrigger, trigger, rules, modelValue);
      });
    }; // expose


    var reset = () => {
      var {
        min
      } = props;
      call(props['onUpdate:modelValue'], min != null ? toNumber(min) : 0);
      resetValidation();
    };

    var counterProvider = {
      reset,
      validate,
      resetValidation
    };
    var isMax = computed(() => {
      var {
        max,
        modelValue
      } = props;
      return max != null && toNumber(modelValue) >= toNumber(max);
    });
    var isMin = computed(() => {
      var {
        min,
        modelValue
      } = props;
      return min != null && toNumber(modelValue) <= toNumber(min);
    });

    var normalizeValue = value => {
      var {
        decimalLength,
        max,
        min
      } = props;
      var num = toNumber(value);

      if (max != null && num > toNumber(max)) {
        num = toNumber(max);
      }

      if (min != null && num < toNumber(min)) {
        num = toNumber(min);
      }

      value = String(num);

      if (decimalLength != null) {
        value = num.toFixed(toNumber(decimalLength));
      }

      return value;
    };

    var handleChange = event => {
      var {
        lazyChange,
        onBeforeChange
      } = props;
      var {
        value
      } = event.target;
      var normalizedValue = normalizeValue(value);
      lazyChange ? call(onBeforeChange, toNumber(normalizedValue), change) : setNormalizedValue(normalizedValue);
      validateWithTrigger('onInputChange');
    };

    var decrement = () => {
      var {
        disabled,
        readonly,
        disableDecrement,
        decrementButton,
        lazyChange,
        step,
        modelValue,
        onDecrement,
        onBeforeChange
      } = props;

      if (formDisabled != null && formDisabled.value || formReadonly != null && formReadonly.value || disabled || readonly || disableDecrement || !decrementButton) {
        return;
      }

      if (isMin.value) {
        return;
      }

      var value = new Decimal(toNumber(modelValue)).minus(new Decimal(toNumber(step))).toString();
      var normalizedValue = normalizeValue(value);
      var normalizedValueNum = toNumber(normalizedValue);
      call(onDecrement, normalizedValueNum);

      if (lazyChange) {
        call(onBeforeChange, normalizedValueNum, change);
      } else {
        setNormalizedValue(normalizedValue);
        validateWithTrigger('onDecrement');
      }
    };

    var increment = () => {
      var {
        disabled,
        readonly,
        disableIncrement,
        incrementButton,
        lazyChange,
        step,
        modelValue,
        onIncrement,
        onBeforeChange
      } = props;

      if (formDisabled != null && formDisabled.value || formReadonly != null && formReadonly.value || disabled || readonly || disableIncrement || !incrementButton) {
        return;
      }

      if (isMax.value) {
        return;
      }

      var value = new Decimal(toNumber(modelValue)).plus(new Decimal(toNumber(step))).toString();
      var normalizedValue = normalizeValue(value);
      var normalizedValueNum = toNumber(normalizedValue);
      call(onIncrement, normalizedValueNum);

      if (lazyChange) {
        call(onBeforeChange, normalizedValueNum, change);
      } else {
        setNormalizedValue(normalizedValue);
        validateWithTrigger('onIncrement');
      }
    };

    var pressDecrement = () => {
      var {
        press,
        lazyChange
      } = props;

      if (!press || lazyChange) {
        return;
      }

      decrementDelayTimer = window.setTimeout(() => {
        continuedDecrement();
      }, DELAY);
    };

    var pressIncrement = () => {
      var {
        press,
        lazyChange
      } = props;

      if (!press || lazyChange) {
        return;
      }

      incrementDelayTimer = window.setTimeout(() => {
        continuedIncrement();
      }, DELAY);
    };

    var releaseDecrement = () => {
      decrementTimer && clearTimeout(decrementTimer);
      decrementDelayTimer && clearTimeout(decrementDelayTimer);
    };

    var releaseIncrement = () => {
      incrementTimer && clearTimeout(incrementTimer);
      incrementDelayTimer && clearTimeout(incrementDelayTimer);
    };

    var continuedIncrement = () => {
      incrementTimer = window.setTimeout(() => {
        increment();
        continuedIncrement();
      }, SPEED);
    };

    var continuedDecrement = () => {
      decrementTimer = window.setTimeout(() => {
        decrement();
        continuedDecrement();
      }, SPEED);
    };

    var setNormalizedValue = normalizedValue => {
      inputValue.value = normalizedValue;
      var normalizedValueNum = toNumber(normalizedValue);
      call(props['onUpdate:modelValue'], normalizedValueNum);
    };

    var change = value => {
      setNormalizedValue(normalizeValue(String(value)));
      validateWithTrigger('onLazyChange');
    };

    call(bindForm, counterProvider);
    watch(() => props.modelValue, newValue => {
      setNormalizedValue(normalizeValue(String(newValue)));
      call(props.onChange, toNumber(newValue));
    });
    setNormalizedValue(normalizeValue(String(props.modelValue)));
    return {
      n,
      classes,
      inputValue,
      errorMessage,
      formDisabled,
      formReadonly,
      isMax,
      isMin,
      validate,
      reset,
      resetValidation,
      handleChange,
      decrement,
      increment,
      pressDecrement,
      pressIncrement,
      releaseDecrement,
      releaseIncrement,
      toSizeUnit,
      toNumber
    };
  }

});