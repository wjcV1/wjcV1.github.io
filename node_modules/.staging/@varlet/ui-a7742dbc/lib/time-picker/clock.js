"use strict";

exports.__esModule = true;
exports.default = void 0;
exports.render = render;

var _vue = require("vue");

var _dayjs = _interopRequireDefault(require("dayjs"));

var _props = require("./props");

var _utils = require("./utils");

var _shared = require("@varlet/shared");

var _components = require("../utils/components");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var {
  n,
  classes
} = (0, _components.createNamespace)('time-picker');

function render(_ctx, _cache) {
  return (0, _vue.openBlock)(), (0, _vue.createElementBlock)("div", {
    class: (0, _vue.normalizeClass)(_ctx.n('clock'))
  }, [(0, _vue.createElementVNode)("div", {
    class: (0, _vue.normalizeClass)(_ctx.n('clock-hand')),
    style: (0, _vue.normalizeStyle)(_ctx.handStyle)
  }, null, 6
  /* CLASS, STYLE */
  ), ((0, _vue.openBlock)(true), (0, _vue.createElementBlock)(_vue.Fragment, null, (0, _vue.renderList)(_ctx.timeScales, (timeScale, index) => {
    return (0, _vue.openBlock)(), (0, _vue.createElementBlock)("div", {
      class: (0, _vue.normalizeClass)(_ctx.classes(_ctx.n('clock-item'), [_ctx.isActive(index, false), _ctx.n('clock-item--active')], [_ctx.isDisable(timeScale), _ctx.n('clock-item--disable')])),
      key: timeScale,
      style: (0, _vue.normalizeStyle)(_ctx.getStyle(index, timeScale, false))
    }, (0, _vue.toDisplayString)(timeScale), 7
    /* TEXT, CLASS, STYLE */
    );
  }), 128
  /* KEYED_FRAGMENT */
  )), _ctx.format === '24hr' && _ctx.type === 'hour' ? ((0, _vue.openBlock)(), (0, _vue.createElementBlock)("div", {
    key: 0,
    class: (0, _vue.normalizeClass)(_ctx.n('clock-inner')),
    ref: "inner"
  }, [((0, _vue.openBlock)(true), (0, _vue.createElementBlock)(_vue.Fragment, null, (0, _vue.renderList)(_ctx.hours24, (hour, index) => {
    return (0, _vue.openBlock)(), (0, _vue.createElementBlock)("div", {
      class: (0, _vue.normalizeClass)(_ctx.classes(_ctx.n('clock-item'), [_ctx.isActive(index, true), _ctx.n('clock-item--active')], [_ctx.isDisable(hour), _ctx.n('clock-item--disable')])),
      key: hour,
      style: (0, _vue.normalizeStyle)(_ctx.getStyle(index, hour, true))
    }, (0, _vue.toDisplayString)(hour), 7
    /* TEXT, CLASS, STYLE */
    );
  }), 128
  /* KEYED_FRAGMENT */
  ))], 2
  /* CLASS */
  )) : (0, _vue.createCommentVNode)("v-if", true)], 2
  /* CLASS */
  );
}

var _default = (0, _vue.defineComponent)({
  render,
  name: 'Clock',
  props: {
    isInner: {
      type: Boolean,
      required: true
    },
    rad: {
      type: Number
    },
    format: {
      type: String,
      default: 'ampm'
    },
    allowedTime: {
      type: Object
    },
    time: {
      type: Object,
      required: true
    },
    useSeconds: {
      type: Boolean,
      default: false
    },
    preventNextUpdate: {
      type: Boolean,
      default: false
    },
    type: {
      type: String,
      default: 'hour'
    },
    ampm: {
      type: String,
      default: 'am'
    },
    color: {
      type: String
    },
    min: {
      type: String
    },
    max: {
      type: String
    }
  },
  emits: ['update', 'change-prevent-update'],

  setup(props, _ref) {
    var {
      emit
    } = _ref;
    var inner = (0, _vue.ref)(null);
    var disableHour = (0, _vue.ref)([]);
    var disable24HourIndex = (0, _vue.ref)([]);
    var handStyle = (0, _vue.computed)(() => ({
      transform: "rotate(" + (0, _shared.toNumber)(props.rad) + "deg)",
      height: props.isInner && props.type === 'hour' ? 'calc(50% - 40px)' : 'calc(50% - 4px)',
      backgroundColor: getHandleColor(),
      borderColor: getHandleColor()
    }));
    var activeItemIndex = (0, _vue.computed)(() => {
      if (props.rad === undefined) return;
      var value = props.rad / 30;
      return value >= 0 ? value : value + 12;
    });
    var timeScales = (0, _vue.computed)(() => {
      if (props.type === 'hour') return _props.hoursAmpm;
      return _props.minSec;
    });

    var isDisableMinSec = (time, isDisable) => {
      var _time;

      time = (_time = time) != null ? _time : props.type === 'minute' ? props.time.minute : props.time.second;
      var disableMethod = props.type === 'minute' ? _utils.getIsDisableMinute : _utils.getIsDisableSecond;
      var values = {
        time: (0, _shared.toNumber)(time),
        format: props.format,
        ampm: props.ampm,
        hour: props.time.hour,
        minute: (0, _shared.toNumber)(props.time.minute),
        max: props.max,
        min: props.min,
        allowedTime: props.allowedTime,
        disableHour: disableHour.value
      };
      if (isDisable && props.type === 'minute') Reflect.deleteProperty(values, 'minute');
      return disableMethod(values);
    };

    var getHandleColor = () => {
      if (activeItemIndex.value === undefined) return props.color;
      var hour = props.isInner ? _props.hours24[activeItemIndex.value] : timeScales.value[activeItemIndex.value];

      if (timeScales.value === _props.minSec) {
        return isDisableMinSec() ? '#bdbdbd' : props.color;
      }

      return isDisable(hour) ? '#bdbdbd' : props.color;
    };

    var isActive = (index, inner) => {
      if (inner) return activeItemIndex.value === index && props.isInner;
      return activeItemIndex.value === index && (!props.isInner || props.type !== 'hour');
    };

    var isDisable = time => {
      if (props.type === 'hour') {
        if ((0, _utils.notConvert)(props.format, props.ampm)) return disableHour.value.includes(time);

        var timeIndex = _props.hoursAmpm.findIndex(hour => hour === time);

        return disable24HourIndex.value.includes(timeIndex);
      }

      return isDisableMinSec(time, true);
    };

    var getStyle = (index, hour, inner) => {
      var rad = 2 * Math.PI / 12 * index - Math.PI / 2;
      var left = 50 * (1 + Math.cos(rad));
      var top = 50 * (1 + Math.sin(rad));

      var computedColor = () => {
        if (!isActive(index, inner)) {
          return {
            backgroundColor: undefined,
            color: undefined
          };
        }

        if (isDisable(hour)) {
          return {
            backgroundColor: '#bdbdbd',
            color: '#fff'
          };
        }

        return {
          backgroundColor: props.color,
          color: undefined
        };
      };

      var {
        backgroundColor,
        color
      } = computedColor();
      return {
        left: left + "%",
        top: top + "%",
        backgroundColor,
        color
      };
    };

    var getSize = () => {
      var {
        width,
        height
      } = inner.value.getBoundingClientRect();
      return {
        width,
        height
      };
    };

    var getHour = () => {
      if (activeItemIndex.value === undefined) return undefined;
      var hours = props.ampm === 'am' ? _props.hoursAmpm : _props.hours24;
      return hours[activeItemIndex.value].padStart(2, '0');
    };

    (0, _vue.watch)([activeItemIndex, () => props.isInner], (_ref2, _ref3) => {
      var [index, inner] = _ref2;
      var [oldIndex, oldInner] = _ref3;
      var isSame = index === oldIndex && inner === oldInner;
      if (isSame || props.type !== 'hour' || activeItemIndex.value === undefined) return;
      var newHour = inner ? _props.hours24[activeItemIndex.value] : getHour();
      var second = props.useSeconds ? ":" + props.time.second : '';
      var newTime = newHour + ":" + props.time.minute + second;
      if (!props.preventNextUpdate) emit('update', newTime);
      emit('change-prevent-update');
    });
    (0, _vue.watch)(() => props.rad, (rad, oldRad) => {
      if (props.type === 'hour' || rad === undefined || oldRad === undefined) return;
      var radToMinSec = rad / 6 >= 0 ? rad / 6 : rad / 6 + 60;
      var oldRadToMinSec = oldRad / 6 >= 0 ? oldRad / 6 : oldRad / 6 + 60;
      if (radToMinSec === oldRadToMinSec) return;
      var newTime;
      var {
        hourStr
      } = (0, _utils.convertHour)(props.format, props.ampm, props.time.hour);

      if (props.type === 'minute') {
        var newMinute = (0, _dayjs.default)().minute(radToMinSec).format('mm');
        var second = props.useSeconds ? ":" + props.time.second : '';
        newTime = hourStr + ":" + newMinute + second;
      }

      if (props.type === 'second') {
        var newSecond = (0, _dayjs.default)().second(radToMinSec).format('ss');

        var _second = props.useSeconds ? ":" + newSecond : '';

        newTime = hourStr + ":" + props.time.minute + _second;
      }

      emit('update', newTime);
    });
    (0, _vue.watch)([() => props.max, () => props.min, () => props.allowedTime], _ref4 => {
      var [max, min, allowedTime] = _ref4;
      disableHour.value = [];

      if (max && !min) {
        var {
          hour: maxHour
        } = (0, _utils.getNumberTime)(max);

        var disableAmpmHours = _props.hoursAmpm.filter(hour => (0, _shared.toNumber)(hour) > maxHour);

        var disable24Hours = _props.hours24.filter(hour => (0, _shared.toNumber)(hour) > maxHour);

        disableHour.value = [...disableAmpmHours, ...disable24Hours];
      }

      if (!max && min) {
        var {
          hour: minHour
        } = (0, _utils.getNumberTime)(min);

        var _disableAmpmHours = _props.hoursAmpm.filter(hour => (0, _shared.toNumber)(hour) < minHour);

        var _disable24Hours = _props.hours24.filter(hour => (0, _shared.toNumber)(hour) < minHour);

        disableHour.value = [..._disableAmpmHours, ..._disable24Hours];
      }

      if (max && min) {
        var {
          hour: _maxHour
        } = (0, _utils.getNumberTime)(max);
        var {
          hour: _minHour
        } = (0, _utils.getNumberTime)(min);

        var _disableAmpmHours2 = _props.hoursAmpm.filter(hour => (0, _shared.toNumber)(hour) < _minHour || (0, _shared.toNumber)(hour) > _maxHour);

        var _disable24Hours2 = _props.hours24.filter(hour => (0, _shared.toNumber)(hour) < _minHour || (0, _shared.toNumber)(hour) > _maxHour);

        disableHour.value = [..._disableAmpmHours2, ..._disable24Hours2];
      }

      if (allowedTime != null && allowedTime.hours) {
        var {
          hours
        } = allowedTime;

        var _disableAmpmHours3 = _props.hoursAmpm.filter(hour => !hours((0, _shared.toNumber)(hour)));

        var _disable24Hours3 = _props.hours24.filter(hour => !hours((0, _shared.toNumber)(hour)));

        disableHour.value = [...new Set([...disableHour.value, ..._disableAmpmHours3, ..._disable24Hours3])];
      }

      disable24HourIndex.value = disableHour.value.map(hour => _props.hours24.findIndex(hour24 => hour === hour24)).filter(hour => hour >= 0);
    }, {
      immediate: true
    });
    return {
      n,
      classes,
      hours24: _props.hours24,
      timeScales,
      inner,
      handStyle,
      disableHour,
      isActive,
      isDisable,
      getSize,
      getStyle,
      activeItemIndex
    };
  }

});

exports.default = _default;