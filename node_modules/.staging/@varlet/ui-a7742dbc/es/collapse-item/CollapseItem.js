import { defineComponent, ref, nextTick, watch, computed } from 'vue';
import { nextTickFrame, requestAnimationFrame } from '../utils/elements';
import { isArray } from '@varlet/shared';
import { createNamespace } from '../utils/components';
import { useCollapse } from './provide';
import { props } from './props';
import VarIcon from '../icon';
var {
  n,
  classes
} = createNamespace('collapse-item');
import { renderSlot as _renderSlot, toDisplayString as _toDisplayString, createTextVNode as _createTextVNode, normalizeClass as _normalizeClass, createElementVNode as _createElementVNode, resolveComponent as _resolveComponent, createVNode as _createVNode, vShow as _vShow, withDirectives as _withDirectives, openBlock as _openBlock, createElementBlock as _createElementBlock } from "vue";
export function render(_ctx, _cache) {
  var _component_var_icon = _resolveComponent("var-icon");

  return _openBlock(), _createElementBlock("div", {
    class: _normalizeClass(_ctx.classes(_ctx.n(), [_ctx.offset && _ctx.isShow, _ctx.n('--active')], [_ctx.disabled, _ctx.n('--disable')]))
  }, [_createElementVNode("div", {
    class: _normalizeClass(_ctx.n('header')),
    onClick: _cache[0] || (_cache[0] = $event => _ctx.toggle())
  }, [_createElementVNode("div", {
    class: _normalizeClass(_ctx.n('header-title'))
  }, [_renderSlot(_ctx.$slots, "title", {}, () => [_createTextVNode(_toDisplayString(_ctx.title), 1
  /* TEXT */
  )])], 2
  /* CLASS */
  ), _createElementVNode("div", {
    class: _normalizeClass(_ctx.n('header-icon'))
  }, [_renderSlot(_ctx.$slots, "icon", {}, () => [_createVNode(_component_var_icon, {
    name: _ctx.icon,
    transition: 250,
    class: _normalizeClass(_ctx.classes(_ctx.n('header-icon'), [_ctx.isShow && _ctx.icon === 'chevron-down', _ctx.n('header-open')], [_ctx.disabled, _ctx.n('header--disable')]))
  }, null, 8
  /* PROPS */
  , ["name", "class"])])], 2
  /* CLASS */
  )], 2
  /* CLASS */
  ), _withDirectives(_createElementVNode("div", {
    class: _normalizeClass(_ctx.n('content')),
    ref: "contentEl",
    onTransitionend: _cache[1] || (_cache[1] = function () {
      return _ctx.transitionend && _ctx.transitionend(...arguments);
    }),
    onTransitionstart: _cache[2] || (_cache[2] = function () {
      return _ctx.start && _ctx.start(...arguments);
    })
  }, [_createElementVNode("div", {
    class: _normalizeClass(_ctx.n('content-wrap'))
  }, [_renderSlot(_ctx.$slots, "default")], 2
  /* CLASS */
  )], 34
  /* CLASS, HYDRATE_EVENTS */
  ), [[_vShow, _ctx.show]])], 2
  /* CLASS */
  );
}
export default defineComponent({
  render,
  name: 'VarCollapseItem',
  components: {
    VarIcon
  },
  props,

  setup(props) {
    var {
      index,
      collapse,
      bindCollapse
    } = useCollapse();
    var isInitToTrigger = true; // ensure to trigger transitionend

    var contentEl = ref(null);
    var show = ref(false);
    var isShow = ref(false);
    var {
      active,
      offset,
      updateItem
    } = collapse;
    var name = computed(() => props.name);

    var init = (accordion, show) => {
      if (active.value === undefined || accordion && isArray(active.value) || show === isShow.value) return;
      isShow.value = show;
      toggle(true);
    };

    var toggle = initOrAccordion => {
      if (props.disabled) return;

      if (!initOrAccordion) {
        updateItem(props.name || index.value, !isShow.value);
      }
    };

    var openPanel = () => {
      if (!contentEl.value) return;
      contentEl.value.style.height = '';
      show.value = true;
      nextTick(() => {
        var {
          offsetHeight
        } = contentEl.value;
        contentEl.value.style.height = 0 + 'px';
        requestAnimationFrame(() => {
          ;
          contentEl.value.style.height = offsetHeight + 'px';
          if (!isInitToTrigger) return;
          nextTickFrame(() => {
            if (isInitToTrigger) transitionend();
          });
        });
      });
    };

    var start = () => {
      isInitToTrigger = false;
    };

    var closePanel = () => {
      if (!contentEl.value) return;
      var {
        offsetHeight
      } = contentEl.value;
      contentEl.value.style.height = offsetHeight + 'px';
      requestAnimationFrame(() => {
        ;
        contentEl.value.style.height = 0 + 'px';
      });
    };

    var transitionend = () => {
      if (!isShow.value) {
        show.value = false;
      }

      ;
      contentEl.value.style.height = '';
    };

    var collapseItemProvider = {
      index,
      name,
      init
    };
    bindCollapse(collapseItemProvider);
    watch(isShow, value => {
      if (value) openPanel();else closePanel();
    });
    return {
      n,
      start,
      classes,
      show,
      isShow,
      offset,
      toggle,
      contentEl,
      transitionend
    };
  }

});